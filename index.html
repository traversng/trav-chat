<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TravCast</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" integrity="sha512-dTfge/zgoMYpP7QbHy4gWMEGsbsdZeCXz7irItjcC3sPUFtf0kuFbDz/ixG7ArTxmDjLXDmezHubeNikyKGVyQ==" crossorigin="anonymous">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.firebase.com/js/client/2.3.1/firebase.js"></script>
</head>
<body>
<div id="login-wrap">
    <div class="row">
        <div class="main">
            <h3>Please Log In, or <a href="#">Sign Up</a></h3>
            <div class="row">
                <a id="facebook-btn" class="btn btn-block btn-social btn-facebook">
                    <span class="fa fa-facebook"></span> Sign in with Facebook
                </a>
                <a id="google-btn" class="btn btn-block btn-social btn-google">
                    <span class="fa fa-google"></span> Sign in with Google
                </a>
                <a id="github-btn" class="btn btn-block btn-social btn-github">
                    <span class="fa fa-github"></span> Sign in with GitHub
                </a>
            </div>
            <div class="login-or">
                <hr class="hr-or">
                <span class="span-or">or</span>
            </div>
                <form id="login-form" role="form" method="post" action="/login">
                    <div class="form-group">
                        <label for="usernameEmail">Username or email</label>
                        <input type="text" class="form-control" id="usernameEmail">
                    </div>
                    <div class="form-group">
                        <a class="pull-right" href="#">Forgot password?</a>
                        <label for="password">Password</label>
                        <input type="password" class="form-control" id="password">
                    </div>
                    <div class="checkbox pull-right">
                        <label>
                            <input type="checkbox">
                            Remember me </label>
                    </div>
                    <button type="submit" class="btn btn btn-primary">
                        Log In
                    </button>
                </form><!-- login-form -->
            </div>
        </div>
    </div>
</div>
<!--<div id="nickWrap"> ================== Adding Social User Authentication ====================-->
    <!--<p>Enter a username:</p>-->
    <!--<p id="nickError"></p>-->
    <!--<form id="setNick" class="form">-->
        <!--<div class="form-group">-->
            <!--<input class="form-inline" id="nickname" size="35" />-->
            <!--<input class="form btn btn-success" type="submit"/>-->
        <!--</div>-->
    <!--</form>-->
<!--</div>-->
<div id="content-wrap">
    <div id="chat-wrap">
        <div id="chat">
            <!-- Messages are appended here -->
        </div>
        <form id="send-message">
            <input id="message" size="35"/>
            <input class="btn btn-success" type="submit"/>
        </form>
    </div>
</div>

<div id="users">
</div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="https://cdn.socket.io/socket.io-1.3.7.js"></script>
    <script>
        $(function($){
            var socket = io.connect();
            var $messageForm = $('#send-message');
            var $messageBox = $('#message');
            var $chat = $('#chat');
            var $users = $('#users');
            var ref = new Firebase('https://travcast.firebaseio.com');//This creates a connection to our unique firebase db
            var usersRef = ref.child("users");//Creates and uses a database child called users...this is where we will store our users information
            var $username = $('#usernameEmail');
            var $password = $('#password');
            var $facebookBtn = $('#facebook-btn');
            var $githubbtn = $('#github-btn');
            var $googlebtn = $('#google-btn');
            var $loginWrap = $('#login-wrap');
            var $contentWrap = $('#content-wrap');


            // Google authentication and user creation
            $googlebtn.click(function(){
                ref.authWithOAuthPopup("google", function(error, authData) {
                    if (error) {
                        console.log("Login Failed!", error);
                    } else {
                        console.log("Authenticated successfully with payload:", authData);
                        var newUser = usersRef.push();
                        newUser.set({
                            userInfoSrc: authData.provider,
                            name: authData.google.displayName
                        });
                        // add socket event to trigger index.html here...
                        var authenticUser = {
                            name: authData.google.displayName,
                            userInfoSrc: authData.provider
                        };
                        socket.emit('successful login', authenticUser, function(data){
                            console.log('successful login data: ' +data+ 'authenticUser: ' +authenticUser);
                        });
                        $loginWrap.hide();
                        $contentWrap.show();
                    }
                });
            });

            // Github authentication and user creation
            $githubbtn.click(function(){
                ref.authWithOAuthPopup("github", function(error, authData) {
                    if (error) {
                        console.log("Login Failed!", error);
                    } else {
                        console.log("Authenticated successfully with payload:", authData);
                        var newUser = usersRef.push();
                        newUser.set({
                            userInfoSrc: authData.provider,
                            name: authData.github.displayName
                        });
                    }
                });
            });

            // facebook authentication and user creation
            $facebookBtn.click(function(){
                ref.authWithOAuthPopup("facebook", function(error, authData) {
                    if (error) {
                        console.log("Login Failed!", error);
                    } else {
                        console.log("Authenticated successfully with payload:", authData);
                        var newUser = usersRef.push();
                        newUser.set({
                            userInfoSrc: authData.provider,
                            name: authData.facebook.displayName
                        });

                    }
                });

                // Email password user creation/login
                $loginForm.submit(function(e){
                    var newUser = usersRef.push();// Pushing to the existing ref.child('users') creates a new user child everytime this form is submitted whereas if we were to use usersRef.set() we would be overidding the user child everytime
                    newUser.set({
                        username: $username.val(),
                        password: $password.val()
                    });
                    console.log('username: ' +username+ 'password: ' + password);
                });
            });


            socket.on('usernames' , function(data){
                console.log('getting nicknames: ' , data);
                var html = "";
                for(var i = 0; i < data.length; i++){
                    html +="<span onclick=" + "whisperName(this,'/w')" + ">" + data[i] + "</span></br>";
                }
                $users.html(html);
            });

            $messageForm.submit(function(e){
                e.preventDefault();
                socket.emit('send message', $messageBox.val(), function(data){
                    $chat.append("<span class='error'><b>" + data + "</span></br>");
                });
                $messageBox.val("");
            });

            socket.on('new message' , function(data){
                $chat.append("<span class='msg'><b>" + data.nick + ": </b>" + data.msg + "</span></br>");

                //push message to firebase
                ref.push({name: data.nick, text: data.msg, timestamp: Date.now()});
            });

            socket.on('whisper' , function(data){
                $chat.append("<span class='whisper'><br>" + data.nick + " </b>" + "whispers:  " + data.msg + " </span></br>");

                //push message to firebase
                ref.push({name: data.nick, whisper: data.msg, timestamp: Date.now()});
            });

            socket.on('disconnect', function(data){
                //push disconnect event to firebase
                ref.push({name: data.nick, disconnect: data.disconnect});
                $chat.text('client disconnected');
            });
        });



        function whisperName(ele, spChar){
            var str = spChar + " ";
            var $msg = $('#message');

            str += $(ele).text() + " ";
            console.log("String Test:", str);
            $msg.val(str);
            $msg.focus();

            return str;
        }
    </script>
</body>
</html>